#! /usr/bin/env node
const electronInstaller = require('electron-winstaller');
const rcedit = require('rcedit');
const execSync = require('child_process').execSync;
const fs = require('fs');
const glob = require('glob');
const path = require('path');
const JSZip = require('jszip');
const package = require('../package');

const distDir = 'build/dist';

function createWindowsInstaller(arch) {
    const outputPath = `${distDir}/win32/${arch}`;
    const setupExeName = `Install ${package.productName} v${package.version}.exe`;

    console.log('Building installer for ' + platformName(arch));

    electronInstaller.createWindowsInstaller({
        appDirectory: `build/${package.productName}-win32-${arch}`,
        outputDirectory: outputPath,
        exe: `${package.productName}.exe`,
        iconUrl: `https://dist.dividat.ch/win32/dividat-icon.ico`,
        setupExe: setupExeName,
        remoteReleases: `https://dist.dividat.ch/releases/driver/stable/win32/${arch}`,
    }).then(
        () => {
            // Workaround for issue with electron-winstaller
            // https://github.com/electron/windows-installer/issues/119#issuecomment-279945093
            rcedit(
                `${outputPath}/${setupExeName}`,
                { icon: 'src/icons/dividat-installer-icon.ico' },
                () => {}
            );
        },
        (e) => {
            console.error(`Error building ${platformName(arch)} installer: ${e.message}`);
            process.exit(1);
        }
    );
}

function createMacArchive() {
    const archiveName = `${distDir}/darwin/${package.productName} v${package.version} (Mac).zip`;
    const appName = `${package.productName}.app`;
    const appFolder = `build/${package.productName}-darwin-x64`;

    console.log('Creating archive for darwin');

    execSync(`mkdir -p "${path.dirname(archiveName)}"`);

    // Create the ZIP archive with Node for portability
    const archive = new JSZip().folder(appName);
    const contents = glob.sync(`${appName}/**/*`, { cwd: appFolder, nodir: true });
    for (let file of contents) {
        archive.file(
            file,
            fs.createReadStream(path.join(appFolder, file)),
            { type: 'nodebuffer', createFolders: true, compression: 'DEFLATE' }
        );
    }

    archive.generateNodeStream(
        { streamFiles: true }
    ).pipe(
        fs.createWriteStream(archiveName)
    );
}

function platformName(arch) {
    return 'win32 ' + arch;
}

// We only maintain the installer and update channel for 32 architecture,
// having no substantial gains from using 64 bit.
createWindowsInstaller('ia32');
createMacArchive();
