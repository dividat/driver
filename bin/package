#! /usr/bin/env node
const electronInstaller = require('electron-winstaller');
const rcedit = require('rcedit');
const execSync = require('child_process').execSync;
const path = require('path');
const package = require('../package');

const distDir = 'build/dist';

function createInstaller(arch) {
    const outputPath = `${distDir}/win32/${arch}`;
    const setupExeName = `Install ${package.productName} v${package.version}.exe`;

    console.log('Building installer for ' + platformName(arch));

    electronInstaller.createWindowsInstaller({
        appDirectory: `build/${package.productName}-win32-${arch}`,
        outputDirectory: outputPath,
        exe: `${package.productName}.exe`,
        iconUrl: `https://s3.eu-central-1.amazonaws.com/dist.dividat.ch/win32/dividat-icon.ico`,
        setupExe: setupExeName,
        remoteReleases: 'https://github.com/knuton/driver',
        remoteToken: process.env.GITHUB_RELEASE_TOKEN || null
    }).then(
        () => {
            // Workaround for issue with electron-winstaller
            // https://github.com/electron/windows-installer/issues/119#issuecomment-279945093
            rcedit(
                `${outputPath}/${setupExeName}`,
                { icon: 'src/icons/dividat-installer-icon.ico' },
                () => {}
            );
        },
        (e) => console.error(`Error building ${platformName(arch)} installer: ${e.message}`)
    );
}

function createArchive() {
    const archiveName = `${distDir}/darwin/${package.productName} v${package.version} (Mac).zip`;
    const appName = `${package.productName}.app`;
    const appFolder = `build/${package.productName}-darwin-x64`;

    console.log('Creating archive for darwin');

    execSync(`mkdir -p "${path.dirname(archiveName)}"`);
    execSync(`cd "${appFolder}" && zip -r -X "../../${archiveName}" "${appName}"`);
}

function platformName(arch) {
    return 'win32 ' + arch;
}

// We only maintain the installer and update channel for 32 architecture,
// having no substantial gains from using 64 bit.
createInstaller('ia32');
createArchive();
